# Nginx 负载均衡

## 轮询

如果没有定义其他方法，默认情况下使用 nginx 进行负载均衡会使用循环算法，如上面的第一个示例所示。使用循环方案，将根据您在 load-balancer.conf  文件中设置的顺序轮流选择每个服务器。这平衡了短期操作的请求数量。

一个简单的负载均衡的示例，把 www.domain.com 均衡到本机不同的端口，也可以改为均衡到不同的地址上。

```bash
http {
    upstream myproject {
        server 127.0.0.1:8000 weight=3;
        server 127.0.0.1:8001;
        server 127.0.0.1:8002;
        server 127.0.0.1:8003;
    }

    server {
        listen 80;
        server_name www.domain.com;
        location / {
            proxy_pass http://myproject;
        }
    }
}
```

## 加权轮询

在不同主机之间的可用资源不相等的服务器设置中，可能希望某些服务器优先于其他服务器。定义服务器权重允许您使用 nginx 进一步微调负载平衡。负载均衡器中权重最高的服务器最常选择。

```bash
upstream backend {
    server 10.1.0.101 weight=4;
    server 10.1.0.102 weight=2;
    server 10.1.0.103;
}
```

例如，在上面显示的配置中，第一个服务器的选择频率是第二个服务器的两倍，与第三个服务器相比，它再次获得两倍的请求。

## 最少连接

基于最少连接的负载平衡是另一种简单的方法。顾名思义，此方法将请求定向到当时具有最少活动连接的服务器。对于请求有时可能需要更长时间才能完成的应用程序，它比循环法更有效。

要启用最少连接平衡方法，请将参数 least_conn 添加到上游  部分，如下例所示。

```bash
upstream backend {
    least_conn;
    server 10.1.0.101;
    server 10.1.0.102;
    server 10.1.0.103;
}
```

## ip地址哈希

虽然循环和最少连接平衡方案是公平的并且有其用途，但是它们不能提供会话持久性。如果您的Web应用程序要求用户随后被定向到与之前连接相同的后端服务器，则应使用IP哈希方法。IP哈希使用访问者IP地址作为密钥来确定应选择哪个主机来为请求提供服务。这允许访问者每次被定向到同一服务器，被授予服务器可用且访问者的IP地址未被更改。

要使用此方法，请将ip_hash 添加到上游  段，如下面的示例所示。

```bash
upstream backend {
    ip_hash;
    server 10.1.0.101;
    server 10.1.0.102;
    server 10.1.0.103;
}
```

## 健康检查

为了知道哪些服务器可用，nginx 的反向代理实现包括被动服务器健康检查。如果服务器无法响应请求或回复错误，nginx 将注意服务器已失败，并将尝试避免一段时间转发到该服务器的连接。

通过将参数 max_fails 设置为服务器行，可以在负载均衡器配置文件中定义特定时间段内连续不成功的连接尝试次数。默认情况下，如果未指定 max_fails，则将此值设置为1.（可选）将 max_fails 设置为0将禁用对该服务器的运行状况检查。

如果将 max_fails 设置为大于1的值，则后续失败必须在特定时间范围内发生，以便无法计数。此时间范围由参数 fail_timeout 指定，该参数还定义服务器应被视为失败的时间。默认情况下，fail_timeout 设置为10秒。

在服务器标记失败并且 fail_timeout 设置的时间已过后，nginx 将开始使用客户端请求正常探测服务器。如果探测返回成功，则服务器再次标记为实时并且正常包含在负载平衡中。

```bash
upstream backend {
    server 10.1.0.101 weight=5;
    server 10.1.0.102 max_fails=3 fail_timeout=30s;
    server 10.1.0.103;
}
```

使用运行状况检查可以根据需要通过启动或关闭主机来使服务器后端适应当前需求。在高流量期间启动其他服务器可以在新资源自动供负载均衡器使用时轻松提高应用程序性能。
